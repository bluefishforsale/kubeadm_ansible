---
- name: Check if GPU configuration is enabled
  debug:
    msg: "GPU configuration is enabled for this host."
  when: hostvars[inventory_hostname].enable_gpu is defined and hostvars[inventory_hostname].enable_gpu | bool

- name: Install NVIDIA GPU driver
  apt:
    name: nvidia-driver
    state: present
    update_cache: yes
    cache_valid_time: 3600
  when: hostvars[inventory_hostname].enable_gpu is defined and hostvars[inventory_hostname].enable_gpu | bool

- name: Install dependencies for NVIDIA Container Toolkit
  apt:
    name:
      - software-properties-common
      - apt-transport-https
      - ca-certificates
    state: present
    update_cache: yes
    cache_valid_time: 3600
  when: hostvars[inventory_hostname].enable_gpu is defined and hostvars[inventory_hostname].enable_gpu | bool

- name: Check if NVIDIA Container Toolkit repo exists
  stat:
    path: /etc/apt/sources.list.d/nvidia-container-toolkit.list
  register: nvidia_repo_stat

- name: Add NVIDIA Container Toolkit repository
  shell: |
    curl -s -L https://nvidia.github.io/libnvidia-container/gpgkey | sudo tee /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
    distribution=$(. /etc/os-release; echo $ID$VERSION_ID)
    curl -s -L https://nvidia.github.io/libnvidia-container/$distribution/libnvidia-container.list | sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
  when:
    - hostvars[inventory_hostname].enable_gpu is defined and hostvars[inventory_hostname].enable_gpu | bool
    - not nvidia_repo_stat.stat.exists

- name: Install NVIDIA Container Toolkit for containerd
  apt:
    name: nvidia-container-toolkit
    state: present
    update_cache: yes
    cache_valid_time: 3600
  when: hostvars[inventory_hostname].enable_gpu is defined and hostvars[inventory_hostname].enable_gpu | bool

- name: Configure containerd to use NVIDIA runtime
  template:
    src: containerd-nvidia.toml.j2
    dest: /etc/containerd/config.toml
  when: hostvars[inventory_hostname].enable_gpu is defined and hostvars[inventory_hostname].enable_gpu | bool
  notify: Restart containerd

- name: Deploy NVIDIA device plugin for Kubernetes
  kubernetes.core.k8s:
    state: present
    namespace: kube-system
    definition:
      apiVersion: apps/v1
      kind: DaemonSet
      metadata:
        name: nvidia-device-plugin-daemonset
        labels:
          name: nvidia-device-plugin
      spec:
        selector:
          matchLabels:
            name: nvidia-device-plugin
        template:
          metadata:
            labels:
              name: nvidia-device-plugin
          spec:
            containers:
            - name: nvidia-device-plugin-ctr
              image: "nvidia/k8s-device-plugin:1.0.0-beta"
              env:
              - name: "NVIDIA_VISIBLE_DEVICES"
                value: "all"
              - name: "NVIDIA_DRIVER_CAPABILITIES"
                value: "compute,utility"
              volumeMounts:
              - name: device-plugin
                mountPath: /var/lib/kubelet/device-plugins
            volumes:
            - name: device-plugin
              hostPath:
                path: /var/lib/kubelet/device-plugins
  when: hostvars[inventory_hostname].enable_gpu is defined and hostvars[inventory_hostname].enable_gpu | bool
  run_once: true
