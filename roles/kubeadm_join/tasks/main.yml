---
- name: Gather facts from all k8s hosts
  setup:
  delegate_to: "{{ item }}"
  delegate_facts: true
  loop: "{{ groups['k8s'] }}"
  run_once: true

- name: Check if node is already part of the cluster
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf

- name: Check if kubelet is running and healthy
  command: systemctl is-active kubelet
  register: kubelet_status
  changed_when: false
  failed_when: false

- name: Set node_already_joined fact
  set_fact:
    node_already_joined: "{{ kubelet_conf.stat.exists and kubelet_status.rc == 0 }}"

- name: Reset kubeadm on the node (only if not already joined)
  shell: kubeadm reset -f
  when:
    - inventory_hostname != groups['k8s_controller'][0]
    - not node_already_joined
    - not ansible_check_mode
  ignore_errors: true

- name: Remove stale Kubernetes config directories
  file:
    path: /etc/kubernetes
    state: absent
  when:
    - inventory_hostname != groups['k8s_controller'][0]
    - not node_already_joined
    - not ansible_check_mode

- name: Clean etcd data directory (preserve mountpoint if tmpfs)
  shell: rm -rf /var/lib/etcd/*
  when:
    - inventory_hostname != groups['k8s_controller'][0]
    - not node_already_joined
    - not ansible_check_mode

- name: Create directories
  file:
    state: directory
    path: "{{ item }}"
    owner: root
    group: root
    mode: '0755'
  when:
    - inventory_hostname != groups['k8s_controller'][0]
    - not node_already_joined
    - not ansible_check_mode
  with_items:
    - "/etc/kubernetes"
    - "/etc/kubernetes/pki"

- name: Distribute admin.conf to controllers
  copy:
    src: "{{ lookup('env', 'HOME') }}/.kube/config"
    dest: /etc/kubernetes/admin.conf
    owner: root
    group: root
    mode: '0600'
  when:
    - inventory_hostname in groups['k8s_controller']
    - inventory_hostname != groups['k8s_controller'][0]

- name: Generate certificate key on the master node
  shell: kubeadm init phase upload-certs --upload-certs
  register: cert_key_output
  run_once: true
  delegate_to: "{{ groups['k8s_controller'][0] }}"
  when: not ansible_check_mode

- name: Extract the certificate key
  set_fact:
    certificate_key: "{{ cert_key_output.stdout | regex_search('[a-f0-9]{64}') }}"
  when: not ansible_check_mode

- name: Generate a new Kubernetes join token and print the join command
  shell: kubeadm token create --print-join-command
  register: kubeadm_token_raw
  run_once: true
  delegate_to: "{{ groups['k8s_controller'][0] }}"
  when: not ansible_check_mode

- name: Set join command (uses first master IP from controlPlaneEndpoint)
  set_fact:
    kubeadm_join_cmd: "{{ kubeadm_token_raw.stdout }}"
  when: not ansible_check_mode

- name: Display generated join command
  debug:
    msg: "{{ kubeadm_join_cmd }}"
  run_once: true
  when: not ansible_check_mode

- name: Display certificate key
  debug:
    msg: "{{ certificate_key }}"
  run_once: true
  when: not ansible_check_mode

- name: Join additional master nodes
  shell: >
    {{ kubeadm_join_cmd }}
    --ignore-preflight-errors=Port-6443
    --certificate-key {{ certificate_key }}
    --apiserver-advertise-address={{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}
    --control-plane
  throttle: 1
  when:
    - inventory_hostname in groups['k8s_controller']
    - inventory_hostname != groups['k8s_controller'][0]
    - not node_already_joined
    - not ansible_check_mode

- name: Join worker nodes
  shell: "{{ kubeadm_join_cmd }}"
  when:
    - inventory_hostname in groups['k8s_worker']
    - not node_already_joined
    - not ansible_check_mode

- name: Ensure kube-apiserver advertises the correct address
  replace:
    path: /etc/kubernetes/manifests/kube-apiserver.yaml
    regexp: '(\s*-\s*--advertise-address)=.*'
    replace: '\1={{ hostvars[inventory_hostname]["ansible_default_ipv4"]["address"] }}'
  when:
    - inventory_hostname in groups['k8s_controller']
    - inventory_hostname != groups['k8s_controller'][0]
    - not ansible_check_mode

- name: Update kube-apiserver bind address
  replace:
    path: /etc/kubernetes/manifests/kube-apiserver.yaml
    regexp: '(\s*-\s*--bind-address)=.*'
    replace: '\1={{ hostvars[inventory_hostname]["ansible_default_ipv4"]["address"] }}'
  when:
    - inventory_hostname in groups['k8s_controller']
    - inventory_hostname != groups['k8s_controller'][0]
    - not ansible_check_mode

- name: Create .kube directory for user
  file:
    path: /home/{{ ansible_user }}/.kube
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  when: not ansible_check_mode

- name: Copy admin.conf to user .kube directory
  copy:
    src: /etc/kubernetes/admin.conf
    dest: /home/{{ ansible_user }}/.kube/config
    remote_src: yes
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'
  when:
    - inventory_hostname in groups['k8s_controller']
    - not ansible_check_mode
