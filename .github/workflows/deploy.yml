name: Deploy Infrastructure Changes

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
  workflow_dispatch:
    inputs:
      playbook:
        description: 'Playbook to run'
        required: false
        default: 'site.yml'
        type: choice
        options:
        - site.yml
      target_hosts:
        description: 'Target hosts (default: all)'
        required: false
        default: 'all'
      dry_run:
        description: 'Dry run only (no changes)'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    name: Deploy to Infrastructure
    runs-on: self-hosted  # Uses existing homelab runner infrastructure
    
    environment: production  # Requires manual approval for production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python & Ansible
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Ansible and dependencies
      run: |
        pip install ansible-core kubernetes PyYAML jmespath
        
    - name: Set up SSH key
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.ANSIBLE_SSH_PRIVATE_KEY }}
        
    - name: Verify connectivity to hosts
      env:
        ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
      run: |
        # Create temporary vault password file
        echo "$ANSIBLE_VAULT_PASSWORD" > /tmp/.vault_pass
        chmod 600 /tmp/.vault_pass
        
        ansible all -i inventories/production/hosts.ini -m ping --vault-password-file=/tmp/.vault_pass
        
    - name: Run pre-deployment health check
      env:
        ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
      run: |
        # Create temporary vault password file
        echo "$ANSIBLE_VAULT_PASSWORD" > /tmp/.vault_pass
        chmod 600 /tmp/.vault_pass
        
        # Check cluster health before deployment
        ansible k8s_controller[0] -i inventories/production/hosts.ini -m shell \
          -a "curl -s -k https://192.168.1.99:6443/healthz" --vault-password-file=/tmp/.vault_pass
          
        # Clean up
        rm -f /tmp/.vault_pass
          
    - name: Determine playbook to run
      id: playbook
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          PLAYBOOK="${{ github.event.inputs.playbook }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          TARGET_HOSTS="${{ github.event.inputs.target_hosts }}"
        else
          PLAYBOOK="site.yml"
          DRY_RUN="false"
          TARGET_HOSTS="all"
        fi
        
        echo "playbook=${PLAYBOOK}" >> $GITHUB_OUTPUT
        echo "dry_run=${DRY_RUN}" >> $GITHUB_OUTPUT
        echo "target_hosts=${TARGET_HOSTS}" >> $GITHUB_OUTPUT
        
    - name: Run Ansible deployment (dry run)
      if: steps.playbook.outputs.dry_run == 'true'
      env:
        ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
      run: |
        # Create temporary vault password file
        echo "$ANSIBLE_VAULT_PASSWORD" > /tmp/.vault_pass
        chmod 600 /tmp/.vault_pass
        
        ansible-playbook ${{ steps.playbook.outputs.playbook }} \
          -i inventories/production/hosts.ini \
          --limit ${{ steps.playbook.outputs.target_hosts }} \
          --vault-password-file=/tmp/.vault_pass \
          --check --diff
          
        # Clean up
        rm -f /tmp/.vault_pass
          
    - name: Run Ansible deployment (live)
      if: steps.playbook.outputs.dry_run == 'false'
      env:
        ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
      run: |
        # Create temporary vault password file
        echo "$ANSIBLE_VAULT_PASSWORD" > /tmp/.vault_pass
        chmod 600 /tmp/.vault_pass
        
        ansible-playbook ${{ steps.playbook.outputs.playbook }} \
          -i inventories/production/hosts.ini \
          --limit ${{ steps.playbook.outputs.target_hosts }} \
          --vault-password-file=/tmp/.vault_pass \
          --diff
          
        # Clean up
        rm -f /tmp/.vault_pass
          
    - name: Post-deployment verification
      if: success()
      env:
        ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
      run: |
        echo "üîç Running post-deployment verification..."
        
        # Create temporary vault password file
        echo "$ANSIBLE_VAULT_PASSWORD" > /tmp/.vault_pass
        chmod 600 /tmp/.vault_pass
        
        # Check cluster health
        ansible k8s_controller[0] -i inventories/production/hosts.ini -m shell \
          -a "curl -s -k https://192.168.1.99:6443/healthz" --vault-password-file=/tmp/.vault_pass
          
        echo "‚úÖ Post-deployment verification complete"
        
        # Clean up
        rm -f /tmp/.vault_pass
        
    - name: Create deployment summary
      if: always()
      run: |
        echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Playbook:** \`${{ steps.playbook.outputs.playbook }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Target Hosts:** ${{ steps.playbook.outputs.target_hosts }}" >> $GITHUB_STEP_SUMMARY
        echo "**Dry Run:** ${{ steps.playbook.outputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "‚úÖ Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå Deployment failed. Check logs for details." >> $GITHUB_STEP_SUMMARY
        fi

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: Notify Discord on success
      if: needs.deploy.result == 'success'
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK }}
        title: "‚úÖ Deployment Successful"
        description: |
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Playbook:** ${{ needs.deploy.outputs.playbook || 'site.yml' }}
        color: 0x00ff00
        
    - name: Notify Discord on failure  
      if: needs.deploy.result == 'failure'
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK }}
        title: "‚ùå Deployment Failed"
        description: |
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Action:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        color: 0xff0000