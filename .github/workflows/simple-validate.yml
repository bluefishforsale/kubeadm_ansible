name: Simple Validation Test

on:
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  basic-validation:
    name: Basic Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python & Ansible
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install minimal dependencies
      run: |
        pip install ansible-core
        
    - name: Test basic ansible installation
      run: |
        ansible --version
        
    - name: Test inventory parsing  
      run: |
        echo "Testing minimal inventory:"
        ansible-inventory --list -i .github/minimal_inventory.ini
        
        echo "Testing CI inventory:"
        ansible-inventory --list -i .github/ci_inventory.ini
        
    - name: Test site.yml syntax without vault
      run: |
        # Create minimal test vars
        mkdir -p /tmp/test_vars
        echo "---" > /tmp/test_vars/test.yml
        echo "vip: 192.168.1.99" >> /tmp/test_vars/test.yml
        echo "kubernetes_version: 1.32.0" >> /tmp/test_vars/test.yml
        echo "pod_network_cidr: 10.244.0.0/16" >> /tmp/test_vars/test.yml
        echo "pod_services_cidr: 10.96.0.0/12" >> /tmp/test_vars/test.yml
        echo "sandbox_image: registry.k8s.io/pause:3.10" >> /tmp/test_vars/test.yml
        echo "keepalived_auth_pass: testpass" >> /tmp/test_vars/test.yml
        
        # Try syntax check with minimal inventory first
        echo "Testing with minimal inventory:"
        ansible-playbook site.yml --syntax-check -i .github/minimal_inventory.ini -e "@/tmp/test_vars/test.yml" || echo "Minimal inventory syntax check failed"
        
        echo "Testing with CI inventory:"  
        ansible-playbook site.yml --syntax-check -i .github/ci_inventory.ini -e "@/tmp/test_vars/test.yml" || echo "CI inventory syntax check failed"
        
    - name: Show file structure for debugging
      run: |
        echo "Repository structure:"
        find . -type f -name "*.yml" | head -20
        
        echo ""
        echo "Inventory files:"
        ls -la .github/*.ini
        
        echo ""
        echo "Content of minimal_inventory.ini:"
        cat .github/minimal_inventory.ini
        
        echo ""
        echo "Content of ci_inventory.ini:"  
        cat .github/ci_inventory.ini