name: Validate Infrastructure Changes

on:
  pull_request:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
  workflow_dispatch:

jobs:
  ansible-lint:
    name: Ansible Syntax & Lint  
    runs-on: ubuntu-latest
    environment: Github Actions CI
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Ansible and dependencies
      run: |
        pip install ansible-core ansible-lint yamllint
        pip install kubernetes PyYAML
        
    - name: Create ansible.cfg if missing
      run: |
        if [ ! -f ansible.cfg ]; then
          cat > ansible.cfg << EOF
        [defaults]
        inventory = inventories/production/hosts.ini
        roles_path = roles
        retry_files_enabled = False
        host_key_checking = False
        
        [privilege_escalation]
        become = True
        become_method = sudo
        EOF
        fi
        
    - name: Validate inventory syntax
      env:
        ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
      run: |
        # Create temporary vault password file for production inventory test
        echo "$ANSIBLE_VAULT_PASSWORD" > /tmp/.vault_pass
        chmod 600 /tmp/.vault_pass
        
        # Test production inventory (may have vault vars)
        ansible-inventory --list -i inventories/production/hosts.ini --vault-password-file=/tmp/.vault_pass > /dev/null
        
        # Test CI inventory (no vault needed)
        ansible-inventory --list -i .github/ci_inventory.ini > /dev/null
        
        # Clean up
        rm -f /tmp/.vault_pass
        
    - name: Ansible syntax check - main playbook
      env:
        ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
      run: |
        # Create temporary vault password file
        echo "$ANSIBLE_VAULT_PASSWORD" > /tmp/.vault_pass
        chmod 600 /tmp/.vault_pass
        
        # Create temporary CI vars directory
        mkdir -p /tmp/ci_vars
        cp .github/ci_group_vars.yml /tmp/ci_vars/all.yml
        
        ansible-playbook site.yml --syntax-check --vault-password-file=/tmp/.vault_pass -i .github/ci_inventory.ini -e "@/tmp/ci_vars/all.yml"
        
        # Clean up
        rm -rf /tmp/.vault_pass /tmp/ci_vars
        
    - name: Ansible syntax check - individual playbooks
      env:
        ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
      run: |
        # Create temporary vault password file
        echo "$ANSIBLE_VAULT_PASSWORD" > /tmp/.vault_pass
        chmod 600 /tmp/.vault_pass
        
        # Create temporary CI vars directory
        mkdir -p /tmp/ci_vars
        cp .github/ci_group_vars.yml /tmp/ci_vars/all.yml
        
        # Check any individual playbooks that exist
        for playbook in playbooks/*.yml playbooks/*.yaml; do
          if [ -f "$playbook" ]; then
            echo "Checking $playbook"
            ansible-playbook "$playbook" --syntax-check --vault-password-file=/tmp/.vault_pass -i .github/ci_inventory.ini -e "@/tmp/ci_vars/all.yml"
          fi
        done
        
        # Clean up
        rm -rf /tmp/.vault_pass /tmp/ci_vars
        
    - name: Ansible-lint validation
      env:
        ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
      run: |
        # Create temporary vault password file
        echo "$ANSIBLE_VAULT_PASSWORD" > /tmp/.vault_pass
        chmod 600 /tmp/.vault_pass
        
        ansible-lint --version
        ansible-lint site.yml --vault-password-file=/tmp/.vault_pass || true  # Don't fail on warnings initially
        
        # Clean up
        rm -f /tmp/.vault_pass
        
    - name: YAML lint validation
      run: |
        # Lint all YAML files
        find . -name "*.yml" -o -name "*.yaml" | grep -v .git | xargs yamllint -d relaxed

  kubernetes-manifests:
    name: Kubernetes Manifest Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.32.0'
        
    - name: Validate Kubernetes manifests
      run: |
        # Find all K8s YAML manifests and validate them
        find . -path "./.git" -prune -o -name "*.yaml" -print0 | while IFS= read -r -d '' file; do
          if grep -q "apiVersion.*v1\|apps/v1\|rbac" "$file" 2>/dev/null; then
            echo "Validating K8s manifest: $file"
            kubectl --dry-run=client --validate=true apply -f "$file"
          fi
        done

  security-scan:
    name: Security & Best Practices
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Scan for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        
    - name: Check for hardcoded IPs/passwords
      run: |
        # Basic security checks
        echo "Checking for hardcoded secrets..."
        
        # Check for potential hardcoded passwords (but allow known config)
        if grep -r "password\s*=" . --exclude-dir=.git | grep -v "ansible_vault\|vault_password\|ANSIBLE_VAULT" | head -5; then
          echo "âš ï¸ Potential hardcoded passwords found (review above)"
        fi
        
        # Check for private keys (except vault encrypted)
        if find . -name "*.pem" -o -name "*_rsa" | head -5; then
          echo "âš ï¸ Private key files found (review if needed)"
        fi
        
        echo "âœ… Security scan complete"

  check-vault:
    name: Verify Vault Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check vault encryption
        run: |
          echo "Checking vault files are encrypted..."
          
          # Check group_vars vault files
          for vault in group_vars/all/vault.yml; do
            if [ -f "$vault" ]; then
              if ! head -n 1 "$vault" | grep -q "ANSIBLE_VAULT"; then
                echo "ERROR: $vault is not encrypted!"
                exit 1
              else
                echo "âœ… $vault is encrypted"
              fi
            else
              echo "â„¹ï¸  $vault not found"
            fi
          done
          
          # Check any other vault files
          find . -name "*vault*.yml" -o -name "*vault*.yaml" | while read vaultfile; do
            if [ "$vaultfile" != "./group_vars/all/vault.yml" ]; then
              if ! head -n 1 "$vaultfile" | grep -q "ANSIBLE_VAULT"; then
                echo "ERROR: $vaultfile is not encrypted!"
                exit 1
              else
                echo "âœ… $vaultfile is encrypted"
              fi
            fi
          done
          
          echo "âœ… All vault files are properly encrypted"

  dry-run-test:
    name: Dry Run Test
    runs-on: ubuntu-latest
    environment: Github Actions CI
    needs: [ansible-lint, kubernetes-manifests, check-vault]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python & Ansible
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Ansible
      run: |
        pip install ansible-core kubernetes PyYAML
        
    - name: Create mock inventory for dry run
      run: |
        mkdir -p inventories/test
        cat > inventories/test/hosts.ini << EOF
        [proxmox]
        localhost ansible_connection=local
        
        [k8s:children]
        k8s_controller
        k8s_worker
        
        [k8s_controller]
        localhost ansible_connection=local
        
        [k8s_worker]
        localhost ansible_connection=local
        EOF
        
    - name: Dry run - main playbook
      env:
        ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
      run: |
        # Create temporary vault password file
        echo "$ANSIBLE_VAULT_PASSWORD" > /tmp/.vault_pass
        chmod 600 /tmp/.vault_pass
        
        # Create temporary CI vars directory
        mkdir -p /tmp/ci_vars
        cp .github/ci_group_vars.yml /tmp/ci_vars/all.yml
        
        ansible-playbook site.yml -i .github/ci_inventory.ini --check --diff --vault-password-file=/tmp/.vault_pass -e "@/tmp/ci_vars/all.yml" || true
        
        # Clean up
        rm -rf /tmp/.vault_pass /tmp/ci_vars
        
    - name: Dry run - individual playbooks
      env:
        ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
      run: |
        # Create temporary vault password file
        echo "$ANSIBLE_VAULT_PASSWORD" > /tmp/.vault_pass
        chmod 600 /tmp/.vault_pass
        
        # Create temporary CI vars directory
        mkdir -p /tmp/ci_vars
        cp .github/ci_group_vars.yml /tmp/ci_vars/all.yml
        
        # Dry run any individual playbooks that exist
        for playbook in playbooks/*.yml playbooks/*.yaml; do
          if [ -f "$playbook" ]; then
            echo "Dry run: $playbook"
            ansible-playbook "$playbook" -i .github/ci_inventory.ini --check --diff --vault-password-file=/tmp/.vault_pass -e "@/tmp/ci_vars/all.yml" || true
          fi
        done
        
        # Clean up
        rm -rf /tmp/.vault_pass /tmp/ci_vars
        
    - name: Generate deployment summary
      run: |
        echo "## ðŸš€ Deployment Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Ansible syntax validation passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Kubernetes manifests validated" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Security scan completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Dry run test executed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ Ready for deployment after merge!" >> $GITHUB_STEP_SUMMARY