# Additional Prometheus scrape configurations for Kubernetes monitoring
# Add these to your existing prometheus.yml configuration

# Kubernetes API Server monitoring
- job_name: 'kubernetes-apiservers'
  kubernetes_sd_configs:
  - api_server: 'https://192.168.1.99:6443'
    role: endpoints
    tls_config:
      insecure_skip_verify: true
  scheme: https
  tls_config:
    insecure_skip_verify: true
  relabel_configs:
  - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
    action: keep
    regex: default;kubernetes;https

# Kubernetes nodes monitoring via kubelet
- job_name: 'kubernetes-nodes'
  kubernetes_sd_configs:
  - api_server: 'https://192.168.1.99:6443'
    role: node
    tls_config:
      insecure_skip_verify: true
  scheme: https
  tls_config:
    insecure_skip_verify: true
  relabel_configs:
  - action: labelmap
    regex: __meta_kubernetes_node_label_(.+)
  - target_label: __address__
    replacement: 192.168.1.99:6443
  - source_labels: [__meta_kubernetes_node_name]
    regex: (.+)
    target_label: __metrics_path__
    replacement: /api/v1/nodes/${1}/proxy/metrics

# Kubernetes pods monitoring
- job_name: 'kubernetes-pods'
  kubernetes_sd_configs:
  - api_server: 'https://192.168.1.99:6443'
    role: pod
    tls_config:
      insecure_skip_verify: true
  relabel_configs:
  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
    action: keep
    regex: true
  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
    action: replace
    target_label: __metrics_path__
    regex: (.+)
  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
    action: replace
    regex: ([^:]+)(?::\d+)?;(\d+)
    replacement: $1:$2
    target_label: __address__
  - action: labelmap
    regex: __meta_kubernetes_pod_label_(.+)
  - source_labels: [__meta_kubernetes_namespace]
    action: replace
    target_label: kubernetes_namespace
  - source_labels: [__meta_kubernetes_pod_name]
    action: replace
    target_label: kubernetes_pod_name

# kube-state-metrics monitoring
- job_name: 'kube-state-metrics'
  static_configs:
  - targets: ['kube501.home:8080', 'kube502.home:8080', 'kube503.home:8080']  # Try each control node
  metrics_path: /metrics
  scrape_interval: 30s
  scrape_timeout: 10s
  
# Enhanced cAdvisor monitoring for Kubernetes nodes
- job_name: 'kubernetes-cadvisor'
  static_configs:
  - targets: 
    - 'kube501.home:8080'
    - 'kube502.home:8080' 
    - 'kube503.home:8080'
    - 'kube511.home:8080'
  metrics_path: /metrics
  scrape_interval: 30s
  scrape_timeout: 10s
  metric_relabel_configs:
  # Keep only Kubernetes container metrics
  - source_labels: [container_label_io_kubernetes_container_name]
    target_label: kubernetes_container_name
  - source_labels: [container_label_io_kubernetes_pod_name]  
    target_label: kubernetes_pod_name
  - source_labels: [container_label_io_kubernetes_pod_namespace]
    target_label: kubernetes_namespace

# Kubernetes service endpoints monitoring  
- job_name: 'kubernetes-service-endpoints'
  kubernetes_sd_configs:
  - api_server: 'https://192.168.1.99:6443'
    role: endpoints
    tls_config:
      insecure_skip_verify: true
  relabel_configs:
  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
    action: keep
    regex: true
  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]
    action: replace
    target_label: __scheme__
    regex: (https?)
  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
    action: replace
    target_label: __metrics_path__
    regex: (.+)
  - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
    action: replace
    target_label: __address__
    regex: ([^:]+)(?::\d+)?;(\d+)
    replacement: $1:$2
  - action: labelmap
    regex: __meta_kubernetes_service_label_(.+)
  - source_labels: [__meta_kubernetes_namespace]
    action: replace
    target_label: kubernetes_namespace
  - source_labels: [__meta_kubernetes_service_name]
    action: replace
    target_label: kubernetes_name